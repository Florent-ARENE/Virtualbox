<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChordFinder - Interface S√©quentielle</title>
    <link rel="stylesheet" href="/ChordFinder/static/css/style.css">
    <link rel="stylesheet" href="/ChordFinder/static/css/behavioral.css">
</head>
<body>
    <div class="container sequential-interface">
        <h1>üé∏ ChordFinder</h1>
        <p class="subtitle">Interface s√©quentielle - s√©lectionnez corde par corde</p>
        
        <div class="instructions">
			<h3>üìù Comment utiliser ChordFinder :</h3>
			<ul>
				<li><strong>S√©lectionnez une position</strong> pour la corde courante (passage automatique √† la suivante)</li>
				<li><strong>Cliquez sur une case</strong> dans "Accord actuel" pour modifier cette corde directement</li>
				<li><strong>Touches clavier</strong> : ‚Üê et ‚Üí pour naviguer rapidement</li>
			</ul>
		</div>

        <!-- Affichage des erreurs -->
        {% if error_message %}
            <div class="error">{{ error_message }}</div>
        {% endif %}

        <!-- Indicateur de progression -->
        <div class="progress-indicator">
            <span id="progressText">Corde 1 sur 6</span>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 16.67%"></div>
        </div>

        <!-- Affichage corde courante -->
        <div class="current-string-display">
            <div class="current-string-label" id="currentStringLabel">Corde 6</div>
            <div class="current-string-note" id="currentStringNote">Mi grave</div>
            <div class="navigation-arrows">
                <button class="nav-arrow" id="prevArrow" disabled>‚Üê</button>
                <button class="nav-arrow" id="nextArrow" disabled>‚Üí</button>
            </div>
        </div>

        <!-- Zone de s√©lection des frettes avec grille √©quilibr√©e -->
        <div class="fret-selection-area">
            
            <!-- Frettes de base : 2 lignes √©quilibr√©es 7+7 = X,0,1-12 -->
            <div class="fret-grid-basic" id="basicFretGrid">
                <!-- Premi√®re ligne : X, 0, 1, 2, 3, 4, 5 -->
                <button type="button" class="single-fret-button not-played" data-value="x">X</button>
                <button type="button" class="single-fret-button open" data-value="0">0</button>
                <button type="button" class="single-fret-button" data-value="1">1</button>
                <button type="button" class="single-fret-button" data-value="2">2</button>
                <button type="button" class="single-fret-button" data-value="3">3</button>
                <button type="button" class="single-fret-button" data-value="4">4</button>
                <button type="button" class="single-fret-button" data-value="5">5</button>
                <!-- Deuxi√®me ligne : 6, 7, 8, 9, 10, 11, 12 -->
                <button type="button" class="single-fret-button" data-value="6">6</button>
                <button type="button" class="single-fret-button" data-value="7">7</button>
                <button type="button" class="single-fret-button" data-value="8">8</button>
                <button type="button" class="single-fret-button" data-value="9">9</button>
                <button type="button" class="single-fret-button" data-value="10">10</button>
                <button type="button" class="single-fret-button" data-value="11">11</button>
                <button type="button" class="single-fret-button" data-value="12">12</button>
            </div>

            <!-- Bouton d'expansion -->
            <button type="button" class="expand-button" id="expandButton">
                <span class="expand-icon">+</span>
                <span id="expandText">Afficher frettes hautes (13-26)</span>
            </button>

            <!-- Frettes expandables : 13-26 (14 boutons restants) -->
            <div class="expandable-rows" id="expandableRows">
                <div class="fret-grid-expandable">
                    <button type="button" class="single-fret-button high-fret" data-value="13">13</button>
                    <button type="button" class="single-fret-button high-fret" data-value="14">14</button>
                    <button type="button" class="single-fret-button high-fret" data-value="15">15</button>
                    <button type="button" class="single-fret-button high-fret" data-value="16">16</button>
                    <button type="button" class="single-fret-button high-fret" data-value="17">17</button>
                    <button type="button" class="single-fret-button high-fret" data-value="18">18</button>
                    <button type="button" class="single-fret-button high-fret" data-value="19">19</button>
                    <button type="button" class="single-fret-button high-fret" data-value="20">20</button>
                    <button type="button" class="single-fret-button high-fret" data-value="21">21</button>
                    <button type="button" class="single-fret-button high-fret" data-value="22">22</button>
                    <button type="button" class="single-fret-button high-fret" data-value="23">23</button>
                    <button type="button" class="single-fret-button high-fret" data-value="24">24</button>
                    <button type="button" class="single-fret-button high-fret" data-value="25">25</button>
                    <button type="button" class="single-fret-button high-fret" data-value="26">26</button>
                </div>
            </div>
        </div>

        <!-- R√©sum√© de l'accord -->
        <div class="selected-values">
            <h3>üéµ Accord actuel :</h3>
            <div class="chord-summary">
                <div class="chord-string-display current-editing" data-string="0">
                    <div class="string-number">Corde 6</div>
                    <div class="string-value" id="stringValue0">-</div>
                    <div class="string-name">Mi grave</div>
                </div>
                <div class="chord-string-display" data-string="1">
                    <div class="string-number">Corde 5</div>
                    <div class="string-value" id="stringValue1">-</div>
                    <div class="string-name">La</div>
                </div>
                <div class="chord-string-display" data-string="2">
                    <div class="string-number">Corde 4</div>
                    <div class="string-value" id="stringValue2">-</div>
                    <div class="string-name">R√©</div>
                </div>
                <div class="chord-string-display" data-string="3">
                    <div class="string-number">Corde 3</div>
                    <div class="string-value" id="stringValue3">-</div>
                    <div class="string-name">Sol</div>
                </div>
                <div class="chord-string-display" data-string="4">
                    <div class="string-number">Corde 2</div>
                    <div class="string-value" id="stringValue4">-</div>
                    <div class="string-name">Si</div>
                </div>
                <div class="chord-string-display" data-string="5">
                    <div class="string-number">Corde 1</div>
                    <div class="string-value" id="stringValue5">-</div>
                    <div class="string-name">Mi aigu</div>
                </div>
            </div>
        </div>

        <form id="chordForm" method="POST" onsubmit="return submitForm();">
            <!-- Champs cach√©s -->
            <input type="hidden" name="string0" id="string0">
            <input type="hidden" name="string1" id="string1">
            <input type="hidden" name="string2" id="string2">
            <input type="hidden" name="string3" id="string3">
            <input type="hidden" name="string4" id="string4">
            <input type="hidden" name="string5" id="string5">

            <!-- Container des boutons optimis√© -->
            <div class="action-buttons-container">
                <button type="submit" class="action-button primary" id="submitButton" disabled>
                    üîç TROUVER
                </button>
                
                <button type="button" class="action-button secondary" id="shareButton">
                    üîó PARTAGER
                </button>
                
                <button type="button" class="action-button danger" id="clearButton">
                    üóëÔ∏è EFFACER
                </button>
            </div>
        </form>

        <!-- Point d'ancrage pour le scroll -->
        <div id="scroll-anchor" style="padding-top: 20px;"></div>

        <!-- Modale de chargement -->
        <div class="modal" id="loaderModal">
            <div class="modal-content">
                <h2>Recherche en cours...</h2>
                <div class="loader"></div>
            </div>
        </div>

        <!-- Affichage des r√©sultats -->
        {% if exact_matches %}
            <div id="results" class="result">
                <h2>Accords trouv√©s avec les positions exactes :</h2>
                {% for image in exact_matches %}
                    <div class="chord-result">
                        <h3>{{ image.chord_name }} - {{ image.chord_type }}</h3>
                        <img src="{{ image.image_url }}" alt="Image de l'accord {{ image.chord_name }}">
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        {% if other_positions %}
            <div class="result">
            {% if exact_matches %}
                <h2>Autres positions trouv√©es :</h2>
            {% else %}
                <h2 id="results">Aucun accord trouv√© pour ces positions.</h2>
                <h2>Accords les plus proches :</h2>
            {% endif %}
                {% for image in other_positions %}
                    <div class="chord-result">
                        <h3>{{ image.chord_name }} - {{ image.chord_type }}</h3>
                        <img src="{{ image.image_url }}" alt="Image de l'accord {{ image.chord_name }}">
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>

    <script>
        // √âtat de l'application avec persistance session
        const appState = {
            currentString: 0,
            stringValues: ['', '', '', '', '', ''],
            stringNames: ['Mi grave', 'La', 'R√©', 'Sol', 'Si', 'Mi aigu'],
            stringLabels: ['Corde 6', 'Corde 5', 'Corde 4', 'Corde 3', 'Corde 2', 'Corde 1'],
            expandedFrets: false
        };

        // Cl√©s pour le stockage session
        const STORAGE_KEYS = {
            EXPANDED_FRETS: 'chordfinder_expanded_frets',
            CHORD_VALUES: 'chordfinder_chord_values'
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            loadSessionState();
            initializeInterface();
            updateCurrentStringDisplay();
            updateProgress();
        });

        function initializeInterface() {
            // √âcouteurs pour tous les boutons de frettes
            document.querySelectorAll('.single-fret-button').forEach(button => {
                button.addEventListener('click', function() {
                    selectFret(this.dataset.value);
                });
            });

            // √âcouteur pour le bouton d'expansion
            document.getElementById('expandButton').addEventListener('click', toggleFretsExpansion);

            // √âcouteurs pour la navigation
            document.getElementById('prevArrow').addEventListener('click', () => navigateToString(appState.currentString - 1));
            document.getElementById('nextArrow').addEventListener('click', () => navigateToString(appState.currentString + 1));

            // √âcouteurs pour les cases de l'accord actuel
            document.querySelectorAll('.chord-string-display').forEach(display => {
                display.addEventListener('click', function() {
                    const stringIndex = parseInt(this.dataset.string);
                    navigateToString(stringIndex);
                });
            });

            // Boutons d'action
            document.getElementById('clearButton').addEventListener('click', clearAllSelections);
            document.getElementById('shareButton').addEventListener('click', copyShareableLink);

            // Navigation clavier
            document.addEventListener('keydown', function(e) {
                if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    navigateToString(appState.currentString - 1);
                } else if (e.key === 'ArrowRight') {
                    e.preventDefault();
                    navigateToString(appState.currentString + 1);
                } else if (e.key === 'Escape') {
                    clearAllSelections();
                } else if (e.key === ' ') {
                    e.preventDefault();
                    toggleFretsExpansion();
                }
            });
        }

        // ===== SYST√àME D'EXPANSION DES FRETTES =====
        function toggleFretsExpansion() {
            const expandableRows = document.getElementById('expandableRows');
            const expandButton = document.getElementById('expandButton');
            const expandText = document.getElementById('expandText');
            const expandIcon = document.querySelector('.expand-icon');

            appState.expandedFrets = !appState.expandedFrets;

            if (appState.expandedFrets) {
                // Expansion
                expandableRows.classList.remove('collapsing');
                expandableRows.classList.add('expanded');
                expandButton.classList.add('expanded');
                expandText.textContent = 'Masquer frettes hautes';
                expandIcon.textContent = '‚àí';
                
                setTimeout(() => {
                    expandableRows.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'nearest' 
                    });
                }, 200);
                
            } else {
                // R√©duction
                expandableRows.classList.add('collapsing');
                expandButton.classList.remove('expanded');
                expandText.textContent = 'Afficher frettes hautes (13-26)';
                expandIcon.textContent = '+';
                
                setTimeout(() => {
                    expandableRows.classList.remove('expanded', 'collapsing');
                }, 400);
            }

            saveExpandedState();
        }

        function saveExpandedState() {
            try {
                sessionStorage.setItem(STORAGE_KEYS.EXPANDED_FRETS, JSON.stringify(appState.expandedFrets));
            } catch (e) {
                console.log('Stockage session non disponible');
            }
        }

        function loadSessionState() {
            try {
                // Charger l'√©tat d'expansion
                const expandedState = sessionStorage.getItem(STORAGE_KEYS.EXPANDED_FRETS);
                if (expandedState !== null) {
                    appState.expandedFrets = JSON.parse(expandedState);
                    
                    if (appState.expandedFrets) {
                        setTimeout(() => {
                            const expandableRows = document.getElementById('expandableRows');
                            const expandButton = document.getElementById('expandButton');
                            const expandText = document.getElementById('expandText');
                            const expandIcon = document.querySelector('.expand-icon');
                            const highFretIndicator = document.getElementById('highFretIndicator');
                            
                            if (expandableRows && expandButton) {
                                expandableRows.classList.add('expanded');
                                expandButton.classList.add('expanded');
                                expandText.textContent = 'Masquer frettes hautes';
                                expandIcon.textContent = '‚àí';
                                highFretIndicator.classList.add('visible');
                            }
                        }, 100);
                    }
                }

                // Charger les valeurs d'accordage
                const chordValues = sessionStorage.getItem(STORAGE_KEYS.CHORD_VALUES);
                if (chordValues) {
                    appState.stringValues = JSON.parse(chordValues);
                    
                    appState.stringValues.forEach((value, index) => {
                        if (value) {
                            updateStringValue(index, value);
                        }
                    });
                    
                    updateSubmitButton();
                }
                
            } catch (e) {
                console.log('Erreur lors du chargement de l\'√©tat de session:', e);
            }
        }

        function saveChordState() {
            try {
                sessionStorage.setItem(STORAGE_KEYS.CHORD_VALUES, JSON.stringify(appState.stringValues));
            } catch (e) {
                console.log('Sauvegarde de l\'accord impossible');
            }
        }

        // ===== LOGIQUE DE S√âLECTION =====
        function selectFret(value) {
            appState.stringValues[appState.currentString] = value;
            
            updateStringValue(appState.currentString, value);
            updateHiddenFields();
            updateSubmitButton();
            updateFretSelection();
            saveChordState();

            // Auto-navigation
            if (appState.currentString < 5) {
                setTimeout(() => {
                    navigateToString(appState.currentString + 1);
                }, 300);
            }
        }

        function navigateToString(stringIndex) {
            if (stringIndex < 0 || stringIndex > 5) return;

            appState.currentString = stringIndex;
            updateCurrentStringDisplay();
            updateStringNavigation();
            updateProgress();
            updateFretSelection();
        }

        function updateCurrentStringDisplay() {
            document.getElementById('currentStringLabel').textContent = appState.stringLabels[appState.currentString];
            document.getElementById('currentStringNote').textContent = appState.stringNames[appState.currentString];

            document.getElementById('prevArrow').disabled = appState.currentString === 0;
            document.getElementById('nextArrow').disabled = appState.currentString === 5;

            document.querySelectorAll('.chord-string-display').forEach((display, index) => {
                display.classList.remove('current-editing');
                if (index === appState.currentString) {
                    display.classList.add('current-editing');
                }
            });
        }

        function updateStringNavigation() {
            document.querySelectorAll('.chord-string-display').forEach((display, index) => {
                display.classList.remove('current-editing', 'completed');
                if (index === appState.currentString) {
                    display.classList.add('current-editing');
                } else if (appState.stringValues[index]) {
                    display.classList.add('completed');
                }
            });
        }

        function updateProgress() {
            const progress = (appState.currentString + 1) / 6 * 100;
            document.getElementById('progressText').textContent = `Corde ${appState.currentString + 1} sur 6`;
            document.getElementById('progressFill').style.width = `${progress}%`;
        }

        function updateFretSelection() {
            const currentValue = appState.stringValues[appState.currentString];
            
            document.querySelectorAll('.single-fret-button').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.dataset.value === currentValue) {
                    btn.classList.add('selected');
                }
            });
        }

        function updateStringValue(stringIndex, value) {
            document.getElementById(`stringValue${stringIndex}`).textContent = value;
            
            const display = document.querySelector(`.chord-string-display[data-string="${stringIndex}"]`);
            if (display) {
                display.classList.add('completed');
            }
        }

        function updateHiddenFields() {
            appState.stringValues.forEach((value, index) => {
                document.getElementById(`string${index}`).value = value;
            });
        }

        function updateSubmitButton() {
            const allCompleted = appState.stringValues.every(v => v !== '');
            const submitButton = document.getElementById('submitButton');
            
            submitButton.disabled = !allCompleted;
            
            if (allCompleted) {
                submitButton.textContent = 'üîç TROUVER';
            } else {
                const remaining = 6 - appState.stringValues.filter(v => v !== '').length;
                submitButton.textContent = `${remaining} corde${remaining > 1 ? 's' : ''} restante${remaining > 1 ? 's' : ''}`;
            }
        }

        function submitForm() {
            const allSelected = appState.stringValues.every(val => val !== '');
            if (!allSelected) {
                alert("Veuillez compl√©ter toutes les cordes avant de continuer.");
                return false;
            }
            
            updateURLWithChord();
            showLoader();
            return true;
        }

        function showLoader() {
            const modal = document.getElementById('loaderModal');
            if (modal) modal.style.display = 'flex';
        }

        function updateURLWithChord() {
            const chordParam = appState.stringValues.join(',');
            const url = new URL(window.location);
            url.searchParams.set('chord', chordParam);
            window.history.replaceState({}, '', url);
        }

        function clearAllSelections() {
            appState.stringValues = ['', '', '', '', '', ''];
            appState.currentString = 0;
            
            for (let i = 0; i < 6; i++) {
                document.getElementById(`stringValue${i}`).textContent = '-';
                document.getElementById(`string${i}`).value = '';
            }
            
            document.querySelectorAll('.chord-string-display').forEach(display => {
                display.classList.remove('completed', 'current-editing');
            });
            
            document.querySelectorAll('.single-fret-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            const url = new URL(window.location);
            url.searchParams.delete('chord');
            window.history.replaceState({}, '', url);
            
            try {
                sessionStorage.removeItem(STORAGE_KEYS.CHORD_VALUES);
            } catch (e) {}
            
            updateCurrentStringDisplay();
            updateStringNavigation();
            updateProgress();
            updateSubmitButton();
        }

        function copyShareableLink() {
            if (appState.stringValues.some(val => val !== '')) {
                updateURLWithChord();
                navigator.clipboard.writeText(window.location.href).then(() => {
                    showNotification('Lien copiable cr√©√© ! Vous pouvez le partager.');
                }).catch(() => {
                    showNotification('URL mise √† jour dans la barre d\'adresse. Copiez-la pour partager cet accord.');
                });
            } else {
                showNotification('S√©lectionnez d\'abord un accord √† partager.');
            }
        }

        function showNotification(message) {
            const indicator = document.getElementById('highFretIndicator');
            const originalText = indicator.textContent;
            indicator.textContent = message;
            indicator.classList.add('visible');
            
            setTimeout(() => {
                indicator.textContent = originalText;
                if (!appState.expandedFrets) {
                    indicator.classList.remove('visible');
                }
            }, 3000);
        }

        function loadExample() {
            const examples = [
                {name: 'Do majeur', values: ['x', '3', '2', '0', '1', '0']},
                {name: 'Sol majeur', values: ['3', '2', '0', '0', '3', '3']},
                {name: 'Mi mineur', values: ['0', '2', '2', '0', '0', '0']},
                {name: 'La majeur', values: ['x', '0', '2', '2', '2', '0']},
                {name: 'R√© majeur', values: ['x', 'x', '0', '2', '3', '2']}
            ];
            
            const randomExample = examples[Math.floor(Math.random() * examples.length)];
            
            clearAllSelections();
            
            randomExample.values.forEach((value, index) => {
                appState.stringValues[index] = value;
                updateStringValue(index, value);
                document.getElementById(`string${index}`).value = value;
            });
            
            updateSubmitButton();
            updateStringNavigation();
            updateFretSelection();
            saveChordState();
            
            showNotification(`Exemple charg√© : ${randomExample.name}`);
        }

        // Ajouter bouton d'exemple optimis√©
        function createExampleButton() {
            const exampleButton = document.createElement('button');
            exampleButton.type = 'button';
            exampleButton.className = 'expand-button compact';
            exampleButton.textContent = 'üé≤ Accord al√©atoire';
            exampleButton.addEventListener('click', loadExample);
            document.querySelector('.selected-values').appendChild(exampleButton);
        }

        createExampleButton();

        // Restauration d'√©tat au chargement
        function restoreState() {
            const urlParams = new URLSearchParams(window.location.search);
            const chordParam = urlParams.get('chord');
            
            if (chordParam) {
                const chordValues = chordParam.split(',');
                if (chordValues.length === 6) {
                    appState.stringValues = chordValues;
                    
                    chordValues.forEach((value, index) => {
                        document.getElementById(`string${index}`).value = value;
                        document.getElementById(`stringValue${index}`).textContent = value;
                        
                        const chordDisplay = document.querySelector(`.chord-string-display[data-string="${index}"]`);
                        if (chordDisplay && value !== '') {
                            chordDisplay.classList.add('completed');
                        }
                    });
                    
                    updateSubmitButton();
                    updateStringNavigation();
                    updateFretSelection();
                    saveChordState();
                    return;
                }
            }

            // Fallback vers champs cach√©s
            let hasValues = false;
            for (let i = 0; i < 6; i++) {
                const hiddenField = document.getElementById(`string${i}`);
                if (hiddenField && hiddenField.value) {
                    const value = hiddenField.value;
                    appState.stringValues[i] = value;
                    document.getElementById(`stringValue${i}`).textContent = value;
                    
                    const chordDisplay = document.querySelector(`.chord-string-display[data-string="${i}"]`);
                    if (chordDisplay) {
                        chordDisplay.classList.add('completed');
                    }
                    
                    hasValues = true;
                }
            }
            
            if (hasValues) {
                updateSubmitButton();
                updateStringNavigation();
                updateFretSelection();
                updateURLWithChord();
                saveChordState();
            }
        }

        // Chargement final
        window.onload = function() {
            restoreState();
            
            const anchor = document.getElementById('scroll-anchor');
            const results = document.getElementById('results');
            
            if (results && anchor) {
                setTimeout(() => {
                    anchor.scrollIntoView({ 
                        behavior: 'smooth',
                        block: 'start'
                    });
                }, 300);
            }
        };
    </script>
</body>
</html>